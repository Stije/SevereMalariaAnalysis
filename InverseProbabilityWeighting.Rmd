---
title: 'Inverse Probability Weighting: Anaemia'
author: "James Watson"
date: "March 20, 2019"
output: html_document
---

```{r, echo=F, include=FALSE}
knitr::opts_chunk$set(cache = TRUE, cache.comments = FALSE, 
                      echo = FALSE, include = TRUE, 
                      fig.width = 7, fig.height = 7,
                      fig.pos = 'H', 
                      dev = 'png', dpi = 300)

RUN_MODELS = F
library(lme4)
#library(merTools)
library(dplyr)
library(fields)
library(boot)
library(mice)
library(plotrix)
#library(glmnet)
```

## Load dataset

```{r}
load('RData/Multiple_Imputed_Datasets.RData')
```



# Inverse probability weighting for the marginal effect of moderate anaemia
## Function to compute IPW for specific exposure levels

The idea is as follows:

* We define all intervals of HCT [h1,h2], such that at least 10 percent and at most 90 percent of patients have HCTs within [h1,h2]
* We use IPW to compare outcomes for patients within the interval and outside each interval [h1,h2]



```{r, echo=FALSE}
compute_IPW_weighting = function(SM_Impute_List, 
                                 LowerLimit_children = 15,
                                 LowerLimit_adults = 20,
                                 UpperLimit_children = 25,
                                 UpperLimit_adults = 30,
                                 prop_threshold,
                                 ipw_quantile_cutoff=.95,
                                 DAG_fmla, age_threshold = 12){
  
  # Go through the datasets and compute weights
  for(k in 1:length(SM_Impute_List)){
    ind_children = SM_Impute_List[[k]]$AgeInYear < age_threshold
    SM_Impute_List[[k]]$ModerateAnaemia = NA
    
    SM_Impute_List[[k]]$ModerateAnaemia[ind_children] =
      ifelse(SM_Impute_List[[k]]$HCT[ind_children] <= UpperLimit_children & 
               SM_Impute_List[[k]]$HCT[ind_children] >= LowerLimit_children,
             1, NA)
    SM_Impute_List[[k]]$ModerateAnaemia[ind_children &
                                          SM_Impute_List[[k]]$HCT > UpperLimit_children] = 0
    
    # Adults    
    ind_adults = SM_Impute_List[[k]]$AgeInYear >= age_threshold
    SM_Impute_List[[k]]$ModerateAnaemia[ind_adults] =
      ifelse(SM_Impute_List[[k]]$HCT[ind_adults] <= UpperLimit_adults & 
               SM_Impute_List[[k]]$HCT[ind_adults] >= LowerLimit_adults,
             1, NA)
    SM_Impute_List[[k]]$ModerateAnaemia[ind_adults &
                                          SM_Impute_List[[k]]$HCT > UpperLimit_adults] = 0
    
    
    complete_ind = !is.na(SM_Impute_List[[k]]$ModerateAnaemia)
    SM_Impute_List[[k]] = SM_Impute_List[[k]][complete_ind,]
    
    # fit the IP weighting model
    mod = glmer(DAG_fmla, data = SM_Impute_List[[k]], family=binomial)
    
    ind_inside = SM_Impute_List[[k]]$ModerateAnaemia == 1
    SM_Impute_List[[k]]$weights = NA
    SM_Impute_List[[k]]$weights[ind_inside] = 
      1/predict(mod,                                          
                newdata=SM_Impute_List[[k]][ind_inside,],
                type='response')
    SM_Impute_List[[k]]$weights[!ind_inside] = 
      1/(1-predict(mod,
                   newdata=SM_Impute_List[[k]][!ind_inside,],
                   type='response'))
    
    
    max_weight = 50
    SM_Impute_List[[k]]$weights[SM_Impute_List[[k]]$weights > max_weight] = NA
    
    
    print(k)
  }
  
  mod_list = lapply(SM_Impute_List, function(x) glm(outcome ~ ModerateAnaemia,
                                                    data = x,
                                                    family='quasibinomial',
                                                    weights = weights))
  mod_summary = pool(mod_list)
  
  IPW_results = list(SM_Impute_List=SM_Impute_List, 
                     mod_summary=mod_summary)
  return(IPW_results)
}
```


```{r}
DAG_fmla = "ModerateAnaemia ~ LPAR_pct + coma + convulsions + AgeInYear +
BD + shock + (1|country) + continent"

res_interval_IPW = compute_IPW_weighting(SM_Impute_List = SM_Impute_List[1:10],
                                         LowerLimit_children = 10,
                                         LowerLimit_adults = 15,
                                         UpperLimit_children = 20,
                                         UpperLimit_adults = 25,
                                         prop_threshold = .05,
                                         DAG_fmla = DAG_fmla)
```



### Inverse probability weighting: Transfusion studies

We stratify by time to death, to remove collider bias.
Select the patients who survive past 4 hours
```{r}
load('RData/Data.RData')
#### We're just looking at the those who didn't die before 4 hours post admission
m$Outcome4hours = 0
m$Outcome4hours[!is.na(m$Timetodeathhrs) & m$Timetodeathhrs < 4] = 1
# We only look at individuals who survive past 4 hours
m = filter(m, Outcome4hours==0)

Transfusion_Data = m[m$studyID%in%c('AQUAMAT','AAV','AQ'),]
round(100*table(Transfusion_Data$transfusion)/nrow(Transfusion_Data),1)
unique_ids_Transfusion = Transfusion_Data$Unique_ID
```

```{r}
load('RData/Multiple_Imputed_Datasets.RData')
for(i in 1:length(SM_Impute_List)){
  ind = SM_Impute_List[[i]]$Unique_ID %in% unique_ids_Transfusion
  SM_Impute_List[[i]] = SM_Impute_List[[i]][ind,]
}
```



We used the time-to-death stratified data to fit a propensity score model:



```{r}
if(RUN_MODELS){
  DAG_fmla = "transfusion ~ HCT + coma + convulsions + 
              log2(BUN) + BD + shock + hypoglycaemia + AgeInYear +
              (1 | country)"
  # fit the model to each dataset
  Modified_Sm_Impute_List = SM_Impute_List
  for(k in 1:length(Modified_Sm_Impute_List)){
    
    mod_weights = glmer(DAG_fmla, data = Modified_Sm_Impute_List[[k]],
                        family=binomial) 
    ind_children = Modified_Sm_Impute_List[[k]]$HCT > 15 & Modified_Sm_Impute_List[[k]]$HCT <= 25 & Modified_Sm_Impute_List[[k]]$AgeInYear < 12
    ind_adults = Modified_Sm_Impute_List[[k]]$HCT > 20 & Modified_Sm_Impute_List[[k]]$HCT <= 30 & Modified_Sm_Impute_List[[k]]$AgeInYear >= 12
    Modified_Sm_Impute_List[[k]] = Modified_Sm_Impute_List[[k]][ind_children | ind_adults,]
    
    transfused = Modified_Sm_Impute_List[[k]]$transfusion==1
    Modified_Sm_Impute_List[[k]]$weights = NA
    Modified_Sm_Impute_List[[k]]$weights[transfused] = 1/predict(mod_weights,
                                                                 newdata=Modified_Sm_Impute_List[[k]][transfused,],
                                                                 type='response')
    Modified_Sm_Impute_List[[k]]$weights[!transfused] = 1/(1-predict(mod_weights,
                                                                     newdata=Modified_Sm_Impute_List[[k]][!transfused,],
                                                                     type='response'))
    max_weight = 100#quantile(Modified_Sm_Impute_List[[k]]$weights,probs = .99)
    Modified_Sm_Impute_List[[k]]$weights[Modified_Sm_Impute_List[[k]]$weights>max_weight]=NA
    print(k)
  }
  save(Modified_Sm_Impute_List, file = 'RData/Imputed_List_Weights.RData')
  
} else {
  load('RData/Imputed_List_Weights.RData')
}

mod_imputed_all = lapply(Modified_Sm_Impute_List, function(x) {
  glm(formula = outcome ~ transfusion, 
      data = x,
      weights = weights,
      family = 'quasibinomial')
} )
summary_mod = summary(pool(mod_imputed_all))

writeLines(sprintf('The global estimate of the odds ratio for death in transfused versus not is %s (%s-%s)',
                   round(exp(summary_mod$estimate[2]),2),
                   round(exp(summary_mod$estimate[2] - 1.96*summary_mod$std.error[2]),2),
                   round(exp(summary_mod$estimate[2] + 1.96*summary_mod$std.error[2]),2)))


mod_imputed_children = lapply(Modified_Sm_Impute_List, function(x){
  ind_children = x[,'AgeInYear'] < 15
  glm(formula = outcome ~ transfusion, 
      data = x[ind_children,],
      weights = weights,
      family = 'quasibinomial')
} )
summary_mod = summary(pool(mod_imputed_children))

writeLines(sprintf('The estimate in those < 15 years of age of the odds ratio for death in transfused versus not is %s (%s-%s)',
                   round(exp(summary_mod$estimate[2]),2),
                   round(exp(summary_mod$estimate[2]-1.96*summary_mod$std.error[2]),2),
                   round(exp(summary_mod$estimate[2]+1.96*summary_mod$std.error[2]),2)))


mod_imputed_adults = lapply(Modified_Sm_Impute_List, function(x){
  ind_adults = x$AgeInYear >= 15
  glm(formula = outcome ~ transfusion, 
      data = x[ind_adults,],
      weights = weights,
      family = 'quasibinomial')
} )
summary_mod = summary(pool(mod_imputed_adults))

writeLines(sprintf('The estimate in those > 15 years of age of the odds ratio for death in transfused versus not is %s (%s-%s)',
                   round(exp(summary_mod$estimate[2]),2),
                   round(exp(summary_mod$estimate[2]-1.96*summary_mod$std.error[2]),2),
                   round(exp(summary_mod$estimate[2]+1.96*summary_mod$std.error[2]),2)))

```


Plot an example of rewighting:
```{r Transfusion_IPW}
par(las=1, mfrow=c(2,2))

k = sample(x = 1:length(Modified_Sm_Impute_List),1)

ind_children =  Modified_Sm_Impute_List[[k]]$AgeInYear < 12
ind_adults = Modified_Sm_Impute_List[[k]]$AgeInYear >= 12

transfused = Modified_Sm_Impute_List[[k]]$transfusion==1

hist(Modified_Sm_Impute_List[[k]]$HCT[ind_children&transfused],
     breaks = seq(15,25.5, length.out = 6),
     col = adjustcolor('red',alpha.f = .3),xaxt='n',
     main='', xlab='Haematocrit (%)', ylab = 'Number of patients')
hist(Modified_Sm_Impute_List[[k]]$HCT[ind_children& !transfused],
     breaks = seq(15,25.5, length.out = 6),
     add=T,col=adjustcolor('blue',alpha.f = .3))
legend('topright',bty='n',legend = c('Tranfused','Not transfused'),
       col = adjustcolor(c('red','blue'),alpha.f = 0.3), lwd=3, cex=.8)
title('Unweighted data')
axis(1,at = (15:25))



hist(Modified_Sm_Impute_List[[k]]$HCT[ind_adults& !transfused],
     breaks = seq(20,32, length.out = 6),
     col = adjustcolor('blue',alpha.f = .3),xaxt='n',
     main='', xlab='Haematocrit (%)', ylab = 'Number of patients')
hist(Modified_Sm_Impute_List[[k]]$HCT[ind_adults& transfused],
     breaks = seq(20,32, length.out = 6),
     add=T,col=adjustcolor('red',alpha.f = .3))
legend('topright',bty='n',legend = c('Tranfused','Not transfused'),
       col = adjustcolor(c('red','blue'),alpha.f = 0.3), lwd=3, cex=.8)
title('Unweighted data')
axis(1,at = (21:35))



ind_not_na = !is.na(Modified_Sm_Impute_List[[k]]$weights)
weighted.hist(x = Modified_Sm_Impute_List[[k]]$HCT[ind_not_na & !transfused & ind_children],
              w = Modified_Sm_Impute_List[[k]]$weights[ind_not_na& !transfused & ind_children],
              col=adjustcolor('blue',alpha.f = .3),breaks = seq(15,25.5, length.out = 6),
              ylab = 'Pseudo number of patients',xaxt='n')
weighted.hist(x = Modified_Sm_Impute_List[[k]]$HCT[ind_not_na & transfused & ind_children],
              w = Modified_Sm_Impute_List[[k]]$weights[ind_not_na & transfused & ind_children],
              col=adjustcolor('red',alpha.f = .3),breaks = seq(15,25.5, length.out = 6),
              add=T, ylab = '')
title('Propensity score weighted data')


weighted.hist(x = Modified_Sm_Impute_List[[k]]$HCT[ind_not_na & transfused & ind_adults],
              w = Modified_Sm_Impute_List[[k]]$weights[ind_not_na& transfused & ind_adults],
              col=adjustcolor('red',alpha.f = .3),breaks = seq(20,32, length.out = 6),
              ylab = 'Pseudo number of patients',xaxt='n')
weighted.hist(x = Modified_Sm_Impute_List[[k]]$HCT[ind_not_na & !transfused & ind_adults],
              w = Modified_Sm_Impute_List[[k]]$weights[ind_not_na & !transfused & ind_adults],
              col=adjustcolor('blue',alpha.f = .3),breaks = seq(20,32, length.out = 6),
              add=T, ylab = '')
title('Propensity score weighted data')

```


