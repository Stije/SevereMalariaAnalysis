---
title: "Charactersing effect of anaemia on mortality in severe malaria"
output:
  html_document:
    keep_md: yes
    fig_caption: yes
---

```{r, echo=F}
knitr::opts_chunk$set(cache = TRUE, cache.comments = FALSE, 
                      echo = TRUE, include = TRUE, 
                      fig.width = 7, fig.height = 7,
                      fig.pos = 'H', 
                      dev = 'png', dpi = 300)
```

# Background

This looks at the severe malaria legacy dataset from MORU

```{r, echo=FALSE}
load('RData/Data.R')
# some basic data cleaning - probably should move this to the MakeRData r script
m$drug_class = as.factor(m$drug_class)
rm_ind = is.na(m$outcome) | is.na(m$studyID)
m = m[!rm_ind, ]
m$BUN[m$BUN > 140] = 140
Leg_data = m[,]  # for the plotting
```




```{r, echo=FALSE, include=FALSE}
library(lme4)
# For the GAM modelling
library(mgcv)
# For the CART modelling
library(rpart)
library(rpart.plot)
```

# Imputation of missing variables

Quite a lot of the important covariates are missing in the older studies. We use linear regression to estimate these unknown variables. This section shows the results for single imputation - when fitting the final models we use multiple imputation.

* Mising base deficit is imputed using bicarbonate (if available) else using respiratory rate
* Missing Blood urea nitrogen is imputed using creatinine

Impute base deficit from bicarbonate
```{r}
BD_and_bicarbonate = !is.na(Leg_data$BD) & !is.na(Leg_data$bicarbonate)
print(paste('We have ', sum(BD_and_bicarbonate), 'observations for both bicarbonate and base deficit'))
mod_impute1 = lmer(BD ~ bicarbonate + (1 | studyID) + (1 | country), data= Leg_data[BD_and_bicarbonate,])
missing_BD = is.na(Leg_data$BD)
Available_Bicarbonate = !is.na(Leg_data$bicarbonate)
print(paste(sum(missing_BD & Available_Bicarbonate), 'observations will now be imputed'))
# impute with model
Leg_data$BD[missing_BD & Available_Bicarbonate] = predict(mod_impute1,newdata=Leg_data[missing_BD & Available_Bicarbonate,], re.form=NA)
```

Impute base deficit from lactate
```{r}
BD_and_lactate = !is.na(Leg_data$BD) & !is.na(Leg_data$lactate)
print(paste('We have ', sum(BD_and_lactate), 'observations for both lactate and base deficit'))
if(length(unique(Leg_data$studyID[BD_and_lactate]))==1){
  mod_impute2 = lm(BD ~ lactate, data= Leg_data[BD_and_lactate,])
} else {
  mod_impute2 = lmer(BD ~ lactate + (1 | studyID), data= Leg_data[BD_and_lactate,])
}
missing_BD = is.na(Leg_data$BD)
Available_Lactate = !is.na(Leg_data$lactate)
print(paste(sum(missing_BD & Available_Lactate), 'observations will now be imputed'))
# impute with model
Leg_data$BD[missing_BD & Available_Lactate] = predict(mod_impute2,newdata=Leg_data[missing_BD & Available_Lactate,], re.form=NA)
```

Impute base deficit from respiratory rate
```{r}
BD_and_rr = !is.na(Leg_data$BD) & !is.na(Leg_data$rr)
print(paste('We have ', sum(BD_and_rr), 'observations for both resp rate and base deficit'))
mod_impute3 = lmer(BD ~ rr + (1 | studyID), data= Leg_data[BD_and_rr,])
missing_BD = is.na(Leg_data$BD)
Available_rr = !is.na(Leg_data$rr)
print(paste(sum(missing_BD & Available_rr), 'observations will now be imputed'))
Leg_data$BD[missing_BD & Available_rr] = predict(mod_impute3,newdata=Leg_data[missing_BD & Available_rr,], re.form=NA)
```


Impute blood urea nitrogen from creatinine:
```{r}
BUN_and_cr = !is.na(Leg_data$BUN) & !is.na(Leg_data$creatinine)
print(paste('We have ', sum(BUN_and_cr), 'observations for both blood urea nitrogen and creatinine'))
mod_impute4 = lmer(BUN ~ creatinine + (1 | studyID), data= Leg_data[BUN_and_cr,])
missing_BUN = is.na(Leg_data$BUN)
Available_cr = !is.na(Leg_data$creatinine)
print(paste(sum(missing_BUN & Available_cr), 'observations will now be imputed'))
Leg_data$BUN[missing_BUN & Available_cr] = predict(mod_impute4,newdata=Leg_data[missing_BUN & Available_cr,], re.form=NA)
```

Resulting data we can now use:
The contributions of the different studies:
```{r}
vars_interest = c('outcome','HCT','LPAR_pct','BD','BUN','poedema',
                  'convulsions','coma','AgeInYear','drug_class')
complete_cases = apply(Leg_data[,vars_interest], 1, function(x) sum(is.na(x))) == 0
Complete_Leg_data = Leg_data[complete_cases,] # for the model fitting
Complete_Leg_data$studyID = as.factor(as.character(Complete_Leg_data$studyID))
# Whole dataset
table(Leg_data$studyID)
# in the complete dataset (all variables recorded)
table(Complete_Leg_data$studyID)
Complete_Leg_data$drug_AS = 0
Complete_Leg_data$drug_AS[Complete_Leg_data$drug_class=='artemisinin']=1

# remove infinite log parasitaemias
ind_keep = !(is.infinite(Complete_Leg_data$LPAR_pct) | is.nan(Complete_Leg_data$LPAR_pct))
Complete_Leg_data = Complete_Leg_data[ind_keep,]
```

Data summaries
```{r}
Africa = c('The Gambia','Mozambique','Ghana','Kenya','Nigeria','Tanzania','Uganda','Rwanda','Congo')
Asia = c('Thailand','Vietnam','Bangladesh','Myanmar','India','Indonesia')
writeLines(paste('Children in Africa:',
                 sum(Complete_Leg_data$AgeInYear < 15 & Complete_Leg_data$country %in% Africa)))
writeLines(paste('Adults in Africa:',
                 sum(Complete_Leg_data$AgeInYear >= 15 & Complete_Leg_data$country %in% Africa)))

writeLines(paste('Children in Asia:',
                 sum(Complete_Leg_data$AgeInYear < 15 & Complete_Leg_data$country %in% Asia)))
writeLines(paste('Adults in Asia:',
                 sum(Complete_Leg_data$AgeInYear >= 15 & Complete_Leg_data$country %in% Asia)))

```

# Exploratory analysis

First we look at the mortality rates across the different studies (only in the Complete_Leg_data, so they won't exactly match the reported fatality rates in the respective papers). This is maling a key assumption that data are missing at random...

```{r, echo=FALSE}
for(s in unique(Complete_Leg_data$studyID)){
  print(paste(s, ', mortality of:', round(100*mean(Complete_Leg_data$outcome[Complete_Leg_data$studyID==s])),'%'))
}
```

We look at the quantiles of the ages in the different studies:
```{r, echo=FALSE}
for(s in unique(Complete_Leg_data$studyID)){
  print(paste0(s, ', ages:', round(quantile(Complete_Leg_data$AgeInYear[Complete_Leg_data$studyID==s], probs = c(0,.5,1))), collapse = ' '))
}

for(s in unique(Complete_Leg_data$studyID)){
  print(s)
  print(table(Complete_Leg_data$drug[Complete_Leg_data$studyID==s]))
}
```


Let's look at the linear associations between the key baseline variables. We use mixed effects linear models to estimate these associations (random effect terms for both country and study).

```{r ExploratoryPlots, echo=FALSE}
par(las=1, mfrow=c(2,2), mar=c(4,4,1,1), bty='n')
## Base Excess and HCT
plot(jitter(Leg_data$HCT,amount=1), jitter(Leg_data$BD), 
     col=Leg_data$studyID, pch='*', xlab='Haematocrit (%)', 
     ylab='Base Deficit')
mod_HCT_BD = gam(formula = BD ~ s(HCT) + s(studyID, bs='re') + 
                   s(country, bs='re'), 
                 data = Complete_Leg_data)
summary(mod_HCT_BD)
ys = predict(object = mod_HCT_BD, 
             newdata = data.frame(HCT=8:50,
                                  studyID='AQ',
                                  country='Vietnam'), 
             exclude = c("s(country)","s(studyID)"))
lines(8:50, ys, lwd=3, col='black')

## Parasitaemia and Anaemia
plot(jitter(Leg_data$HCT,amount=1), Leg_data$LPAR_pct, 
     col=Leg_data$studyID, pch='*', xlab='Haematocrit (%)', 
     ylab='Log10 % parasitised RBCs')
mod_HCT_LPAR = gam(formula = LPAR_pct ~ s(HCT) + s(studyID, bs='re') + 
                   s(country, bs='re'),
                   data = Complete_Leg_data)
summary(mod_HCT_LPAR)
ys = predict(object = mod_HCT_LPAR, 
             newdata = data.frame(HCT=8:50,
                                  studyID='AQ',
                                  country='Vietnam'), 
             exclude = c("s(country)","s(studyID)"))
lines(8:50, ys, lwd=3, col='black')

## BUN and BD
plot(jitter(log10(Leg_data$BUN),amount=.1), jitter(Leg_data$BD), 
     col=Leg_data$studyID, pch='*', xlab='Blood Urea Nitrogen (mmol/L)', 
     ylab='Base Deficit', xaxt='n')
axis(1, at=c(log10(2), 1, 2), labels = c(2,10,100))
mod_BUN_BD = gam(formula = BD ~ s(log10(BUN)) + s(studyID, bs='re') + 
                   s(country, bs='re'),
                 data = Complete_Leg_data)
summary(mod_BUN_BD)
ys = predict(object = mod_BUN_BD, 
             newdata = data.frame(BUN=2:166,
                                  studyID='AQ',
                                  country='Vietnam'), 
             exclude = c("s(country)","s(studyID)"))
lines(log10(2:166), ys, lwd=3, col='black')

## Parasitaemia and Anaemia
plot(jitter(Leg_data$AgeInYear,amount=1), Leg_data$HCT, 
     col=Leg_data$studyID, pch='*', xlab='Age in years', 
     ylab='Haematocrit')
mod_Age_HCT = gam(formula = HCT ~ s(AgeInYear)  + s(studyID, bs='re') + 
                   s(country, bs='re'), 
                  data = Complete_Leg_data)
summary(mod_Age_HCT)
ys = predict(object = mod_Age_HCT, 
             newdata = data.frame(AgeInYear=0:80,
                                  studyID='AQ',
                                  country='Vietnam'), 
             exclude = c("s(country)","s(studyID)"))
lines(0:80, ys, lwd=3, col='black')
```



Now one of the important plots: the un-adjusted association between haematocrit at baseline and death.
This is known as the U curve, and we can see this U association (again I'm adjusting for country and study).
Fitting a GAM here as we know the association is not linear in HCT (previously reported as U-shaped).

```{r HCTalone}
par(las=1, bty='n')
Complete_Leg_data$country=as.factor(Complete_Leg_data$country)
modHCT=gam(outcome ~ s(HCT) + s(studyID, bs='re') + s(country, bs='re'),
           data = Complete_Leg_data, family='binomial')
summary(modHCT)
preds = predict(modHCT, newdata = data.frame(HCT=5:45, studyID='AQ', country='Thailand', country=1), 
                exclude = c("s(country)","s(studyID)"), type='response', se.fit=T)
plot(5:45, 100*preds$fit, ylab='Probability death (%)', xlab='Haematocrit', 
     type='l', lwd=3,ylim = c(5,25))
lines(5:45, 100*preds$fit + 100*2*preds$se.fit, lty=2,lwd=2)
lines(5:45, 100*preds$fit - 100*2*preds$se.fit,lty=2,lwd=2)
abline(h = min(100*preds$fit), lwd=2, lty=3)
```



# Predictive value of anaemia on death adjusting for confounders

This section now looks at the estimated causal effect of anaemia on outcome, if we assume that the posited DAG is correct. We fit both linear and non-linear models to estimate this effect.

Before fitting the more complex GAM models we explore the standard glm (logistic regression) models.

```{r deathmodel_glm}
mod_full_GLM = glmer(outcome ~ HCT + LPAR_pct + AgeInYear + coma + convulsions +
                       poedema + log10(BUN) + BD + drug_AS + 
                       (1 | studyID) + (1 | country),
                     data = Complete_Leg_data, family=binomial)
summary(mod_full_GLM)
```

Now let's make counterfactual retrodictions of anaemia on death for the patients in the database.

```{r counterfactualMortality}
myquantiles = c(0.25,0.5,0.75) # this is 50% predictive interval

overall_median_mortality = median(100*predict(mod_full_GLM, type='response'))
par(las=1, bty='n')
x_hcts = seq(4,45, by=1)
probs_lin = array(dim = c(3, length(x_hcts)))
for(i in 1:length(x_hcts)){
  mydata = Complete_Leg_data
  mydata$HCT=x_hcts[i]
  ys = 100*predict(mod_full_GLM, newdata = mydata, re.form=NA, type='response')
  probs_lin[,i] = quantile(ys, probs=myquantiles)
}
```

The way to interpret this `counterfactual' plot is as follows: suppose that every individual in the dataset was assigned (as in a intervention) a specific haematocrit $X$, what would the resulting per patient probability of death be. Here we summarise these probabilities by the predicted mean probability of death and 80\% predictive intervals.

```{r, echo=FALSE}
plot(x_hcts,probs_lin[2,], xlim=c(4,45), ylab='Predicted probability of death', 
     xlab='Haematocrit (%)', ylim=c(0,20), lty=1, lwd=3, type='l')
lines(x_hcts, probs_lin[1,], lty=2, lwd=2)
lines(x_hcts, probs_lin[3,], lty=2, lwd=2)
abline(h=overall_median_mortality, lwd=3, col='blue',lty=2)
legend('topleft', col=c('black','black','blue'), lwd=3, lty=c(1,2,2),
       legend = c('Median counterfactual value', '25th and 75th counterfactual quantiles','Retrodicted median value'))
```


## More complex GAM model

The GAM model allows for non-linear relationships between certain variables and the outcome.

Here we fit as non-linear the effect of age and haematocrit on mortality.
We add a random effect term for the studyID and a random effect term for the country.
This should be adjusting for a confounder of quality of care (which potentially impacts both general anaemia and outcome in study).

```{r deathmodel_GAM}

mod_full_GAM = gam(outcome ~ s(HCT,AgeInYear) + LPAR_pct  + coma + convulsions +
                     poedema + log10(BUN) + BD + drug_AS + 
                     s(studyID, bs='re') + s(country, bs='re'),
                   data=Complete_Leg_data, family=binomial)
summary(mod_full_GAM)
```


Now we compute the corresponding counterfactual probabilities of death for the dataset for all values of the haematocrit:

```{r }
overall_median_mortalityGAM = median(100*predict(mod_full_GAM, type='response'))
par(las=1, bty='n')
probs_gam = array(dim = c(3, length(x_hcts)))
for(i in 1:length(x_hcts)){
  mydata = Complete_Leg_data
  mydata$HCT=x_hcts[i]
  ys = 100*predict(mod_full_GAM, newdata = mydata, type='response')
  probs_gam[,i] = quantile(ys, probs=myquantiles)
}
```

We see that the effect of haematocrit on mortality is non-linear under this model: below 20 is protective, above 20 plateaus out:

```{r counterfactualPlots}
#
par(las=1, mfrow=c(1,2), bty='n', mar=c(4,4,1,1))
### Plot the standard logistic regression model
plot(x_hcts,probs_lin[2,], xlim=c(4,45), ylab='Predicted probability of death', 
     xlab='Haematocrit (%)', ylim=c(0,20), lty=1, lwd=3, type='l')
lines(x_hcts, probs_lin[1,], lty=2, lwd=2)
lines(x_hcts, probs_lin[3,], lty=2, lwd=2)
abline(h=overall_median_mortality, lwd=3, col='blue',lty=2)
title('Logistic regression model')
### And now the GAM model
plot(x_hcts,probs_gam[2,], xlim=c(4,45), ylab='Predicted probability of death', 
     xlab='Haematocrit (%)', ylim=c(0,20), lty=1, lwd=3, type='l')
lines(x_hcts, probs_gam[1,], lty=2, lwd=2)
lines(x_hcts, probs_gam[3,], lty=2, lwd=2)
abline(h=overall_median_mortalityGAM, lwd=3, col='blue',lty=2)
title('Generalised additive model')
```


## Model comparison

Which model is better fit in terms of AIC

```{r}
print(AIC(mod_full_GAM, mod_full_GLM))
```

And in terms of deviance

```{r}
print(list(mod_full_GLM = deviance(mod_full_GLM), mod_full_GAM=deviance(mod_full_GAM)))
```

