---
title: "Charactersing independent predictors in severe malaria"
output: html_notebook
---

# Background

This looks at the severe malaria legacy dataset from MORU

```{r, echo=FALSE}
load('RData/Data.R')
complete_cases = apply(m, 1, function(x) sum(is.na(x))) == 0
Leg_data = m[complete_cases,]
```


```{r}
library(lme4)
# For the GAM modelling
library(mgcv)
# For the CART modelling
library(rpart)
library(rpart.plot)
```

# Exploratory analysis

Let's look at the key predictive variables. We use a random effects term to model differences between studies.
```{r BD_HCT}
par(las=1)
## Base Excess and HCT
plot(jitter(Leg_data$HCT,amount=1), jitter(Leg_data$BD), 
     col=Leg_data$studyID, pch='*', xlab='Haematocrit', ylab='Base Excess')
legend('topright', col=unique(Leg_data$studyID), legend = unique(Leg_data$studyID), pch='*')
mod = lmer(formula = BD ~ HCT + (1 | studyID), data = Leg_data)
ys = predict(object = mod, newdata = data.frame(HCT=6:50, studyID=NA), re.form=NA)
lines(6:50, ys, lwd=3, col='black')
```

```{r LPAR_HCT}
par(las=1)
## Parasitaemia and Anaemia
plot(jitter(Leg_data$HCT,amount=1), Leg_data$LPAR, 
     col=Leg_data$studyID, pch='*', xlab='Haematocrit', ylab='Log10 Parasitaemia')
legend('topright', col=unique(Leg_data$studyID), legend = unique(Leg_data$studyID), pch='*')
mod = lmer(formula = LPAR ~ HCT + (1 | studyID), data = Leg_data)
ys = predict(object = mod, newdata = data.frame(HCT=6:50, studyID=NA), re.form=NA)
lines(6:50, ys, lwd=3, col='black')
```

```{r BUN_BD}
par(las=1)
## 
plot(jitter(Leg_data$BUN,amount=1), jitter(Leg_data$BD), 
     col=Leg_data$studyID, pch='*', xlab='Blood Urea Nitrogen', ylab='Base Deficit')
legend('topright', col=unique(Leg_data$studyID), legend = unique(Leg_data$studyID), pch='*')
mod = lmer(formula = BD ~ BUN + (1 | studyID), data = Leg_data)
ys = predict(object = mod, newdata = data.frame(BUN=5:75, studyID=NA), re.form=NA)
lines(5:75, ys, lwd=3, col='black')
```


```{r Age_HCT}
par(las=1)
## Parasitaemia and Anaemia
plot(jitter(Leg_data$AgeInYear,amount=1), Leg_data$HCT, 
     col=Leg_data$studyID, pch='*', xlab='Age in years', ylab='Haematocrit')
legend('topright', col=unique(Leg_data$studyID), legend = unique(Leg_data$studyID), pch='*')
mod = lmer(formula = HCT ~ AgeInYear + (1 | studyID), data = Leg_data)
ys = predict(object = mod, newdata = data.frame(AgeInYear=0:50, studyID=NA), re.form=NA)
lines(0:50, ys, lwd=3, col='black')
```



# Predictive value of anaemia on death adjusting for confounders

Before fitting the more complex GAM models we explore the standard glm (logistic regression) models.

```{r deathmodel_glm}
mod_full = glmer(outcome ~ HCT + LPAR + AgeInYear + BUN + BD + (1 | studyID),
               data=Leg_data, family=binomial)
summary(mod_full)
```

Now let's make counterfactual predictions of anaemia on death for the patients in the database:

```{r}
par(las=1)
plot(NA,NA, xlim=c(4,45), ylim=c(0,40),ylab='% predicted mortality', xlab='Haematocrit')
title('Countrerfactual predictions: Overall mortality')
for(HCT in 4:45){
  mydata = Leg_data
  mydata$HCT=HCT
  ys = 100*predict(mod_full, newdata = mydata, re.form=NA, type='response')
  
  points(HCT,mean(ys), pch=18)
  points(rep(HCT,2), quantile(ys, probs=c(0.1,0.9)), pch='-', col='red')
}
abline(h=10, lwd=3, col='blue')
```


