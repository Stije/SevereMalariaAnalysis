---
title: "Charactersing effect of anaemia on mortality in severe malaria"
output:
  pdf_document: 
    fig_caption: yes
    keep_tex: yes
    toc: yes
  html_notebook: default
---

# Background

This looks at the severe malaria legacy dataset from MORU

```{r, echo=FALSE}
load('RData/Data.R')
complete_cases = apply(m, 1, function(x) sum(is.na(x))) == 0
Leg_data = m[,]  # for the plotting
Complete_Leg_data = m[complete_cases,] # for the model fitting
```


```{r}
library(lme4)
# For the GAM modelling
library(mgcv)
# For the CART modelling
library(rpart)
library(rpart.plot)
```

# Exploratory analysis

Let's look at the key predictive variables. We use a random effects term to model differences between studies.
```{r ExploratoryPlots, echo=FALSE}
par(las=1, mfrow=c(2,2), mar=c(4,4,1,1), bty='n')
## Base Excess and HCT
plot(jitter(Leg_data$HCT,amount=1), jitter(Leg_data$BD), 
     col=Leg_data$studyID, pch='*', xlab='Haematocrit (%)', ylab='Base Deficit')
legend('topright', col=unique(Leg_data$studyID), legend = unique(Leg_data$studyID), pch=18, bg ='white')
mod = lmer(formula = BD ~ HCT + (1 | studyID), data = Leg_data)
ys = predict(object = mod, newdata = data.frame(HCT=8:50, studyID=NA), re.form=NA)
lines(8:50, ys, lwd=3, col='black')

## Parasitaemia and Anaemia
plot(jitter(Leg_data$HCT,amount=1), Leg_data$LPAR, 
     col=Leg_data$studyID, pch='*', xlab='Haematocrit (%)', ylab='Log10 Parasitaemia')
#legend('topright', col=unique(Leg_data$studyID), legend = unique(Leg_data$studyID), pch='*')
mod = lmer(formula = LPAR ~ HCT + (1 | studyID), data = Leg_data)
ys = predict(object = mod, newdata = data.frame(HCT=8:50, studyID=NA), re.form=NA)
lines(8:50, ys, lwd=3, col='black')
## BUN and BD
plot(jitter(Leg_data$BUN,amount=1), jitter(Leg_data$BD), xlim=c(0,140),
     col=Leg_data$studyID, pch='*', xlab='Blood Urea Nitrogen', ylab='Base Deficit')
#legend('topright', col=unique(Leg_data$studyID), legend = unique(Leg_data$studyID), pch='*')
mod = lmer(formula = BD ~ BUN + (1 | studyID), data = Leg_data)
ys = predict(object = mod, newdata = data.frame(BUN=5:140, studyID=NA), re.form=NA)
lines(5:140, ys, lwd=3, col='black')

## Parasitaemia and Anaemia
plot(jitter(Leg_data$AgeInYear,amount=1), Leg_data$HCT, 
     col=Leg_data$studyID, pch='*', xlab='Age in years', ylab='Haematocrit')
#legend('topright', col=unique(Leg_data$studyID), legend = unique(Leg_data$studyID), pch='*')
mod = lmer(formula = HCT ~ AgeInYear + (1 | studyID), data = Leg_data)
ys = predict(object = mod, newdata = data.frame(AgeInYear=0:80, studyID=NA), re.form=NA)
lines(0:80, ys, lwd=3, col='black')
```



# Predictive value of anaemia on death adjusting for confounders

Before fitting the more complex GAM models we explore the standard glm (logistic regression) models.

```{r deathmodel_glm}
mod_full = glmer(outcome ~ HCT + LPAR + AgeInYear + BUN + BD + (1 | studyID),
               data=Complete_Leg_data, family=binomial)
summary(mod_full)
```

Now let's make counterfactual predictions of anaemia on death for the patients in the database.
The way to interpret this `counterfactual' plot is as follows: suppose that every individual in the dataset was assigned (as in a intervention) a specific haematocrit $X$, what would the resulting per patient probability of death be. Here we summarise these probabilities by the predicted mean probability of death and 80\% predictive intervals.

```{r counterfactualMortality}
overall_mortality = 100*mean(Leg_data$outcome)
par(las=1, bty='n')
x_hcts = seq(4,45, by=.5)
probs = array(dim = c(3, length(x_hcts)))
for(i in 1:length(x_hcts)){
  mydata = Complete_Leg_data
  mydata$HCT=x_hcts[i]
  ys = 100*predict(mod_full, newdata = mydata, re.form=NA, type='response')
  probs[2,i] = mean(ys)
  probs[c(1,3),i] = quantile(ys, probs=c(0.1,0.9))
}
plot(x_hcts,probs[2,], xlim=c(4,45), ylab='Predicted probability of death', 
     xlab='Haematocrit (%)', ylim=c(0,50), lty=1, lwd=3, type='l')
lines(x_hcts, probs[1,], lty=2, lwd=2)
lines(x_hcts, probs[3,], lty=2, lwd=2)
abline(h=overall_mortality, lwd=3, col='blue',lty=2)
legend('topleft', col=c('black','black','blue'), lwd=3, lty=c(1,2,2),
       legend = c('Mean predicted mortality', '80% predicted interval','Observed mortality'))
```


