---
title: "Charactersing effect of anaemia on mortality in severe malaria"
output:
  html_document:
    keep_md: yes
    fig_caption: yes
---

```{r, echo=F}
knitr::opts_chunk$set(cache = TRUE, cache.comments = FALSE, 
                      echo = TRUE, include = TRUE, 
                      fig.width = 7, fig.height = 7,
                      fig.pos = 'H', 
                      dev = 'png', dpi = 300)
```

# Background

This looks at the severe malaria legacy dataset from MORU

```{r, echo=FALSE}
load('RData/Data.R')
# some basic data cleaning - probably should move this to the MakeRData r script
m$drug_class = as.factor(m$drug_class)
rm_ind = is.na(m$outcome) | is.na(m$studyID)
m = m[!rm_ind, ]
m$BUN[m$BUN > 140] = 140
Leg_data = m[,]  # for the plotting
```




```{r, echo=FALSE, include=FALSE}
library(lme4)
library(mgcv)
require(boot)
```

# Imputation of missing variables

Quite a lot of the important covariates are missing in the older studies. We use linear regression to estimate these unknown variables. This section shows the results for single imputation - when fitting the final models we use multiple imputation.

* Mising base deficit is imputed using bicarbonate (if available) else using respiratory rate
* Missing Blood urea nitrogen is imputed using creatinine

Impute base deficit from bicarbonate
```{r}
BD_and_bicarbonate = !is.na(Leg_data$BD) & !is.na(Leg_data$bicarbonate)
print(paste('We have ', sum(BD_and_bicarbonate), 'observations for both bicarbonate and base deficit'))
mod_impute1 = lmer(BD ~ bicarbonate + (1 | studyID) + (1 | country), data= Leg_data[BD_and_bicarbonate,])
missing_BD = is.na(Leg_data$BD)
Available_Bicarbonate = !is.na(Leg_data$bicarbonate)
print(paste(sum(missing_BD & Available_Bicarbonate), 'observations will now be imputed'))
# impute with model
Leg_data$BD[missing_BD & Available_Bicarbonate] = predict(mod_impute1,newdata=Leg_data[missing_BD & Available_Bicarbonate,], re.form=NA)
```

Impute base deficit from lactate
```{r}
BD_and_lactate = !is.na(Leg_data$BD) & !is.na(Leg_data$lactate)
print(paste('We have ', sum(BD_and_lactate), 'observations for both lactate and base deficit'))
if(length(unique(Leg_data$studyID[BD_and_lactate]))==1){
  mod_impute2 = lm(BD ~ lactate, data= Leg_data[BD_and_lactate,])
} else {
  mod_impute2 = lmer(BD ~ lactate + (1 | studyID), data= Leg_data[BD_and_lactate,])
}
missing_BD = is.na(Leg_data$BD)
Available_Lactate = !is.na(Leg_data$lactate)
print(paste(sum(missing_BD & Available_Lactate), 'observations will now be imputed'))
# impute with model
Leg_data$BD[missing_BD & Available_Lactate] = predict(mod_impute2,newdata=Leg_data[missing_BD & Available_Lactate,], re.form=NA)
```

Impute base deficit from respiratory rate
```{r}
BD_and_rr = !is.na(Leg_data$BD) & !is.na(Leg_data$rr)
print(paste('We have ', sum(BD_and_rr), 'observations for both resp rate and base deficit'))
mod_impute3 = lmer(BD ~ rr + (1 | studyID), data= Leg_data[BD_and_rr,])
missing_BD = is.na(Leg_data$BD)
Available_rr = !is.na(Leg_data$rr)
print(paste(sum(missing_BD & Available_rr), 'observations will now be imputed'))
Leg_data$BD[missing_BD & Available_rr] = predict(mod_impute3,newdata=Leg_data[missing_BD & Available_rr,], re.form=NA)
```


Impute blood urea nitrogen from creatinine:
```{r}
BUN_and_cr = !is.na(Leg_data$BUN) & !is.na(Leg_data$creatinine)
print(paste('We have ', sum(BUN_and_cr), 'observations for both blood urea nitrogen and creatinine'))
mod_impute4 = lmer(BUN ~ creatinine + (1 | studyID), data= Leg_data[BUN_and_cr,])
missing_BUN = is.na(Leg_data$BUN)
Available_cr = !is.na(Leg_data$creatinine)
print(paste(sum(missing_BUN & Available_cr), 'observations will now be imputed'))
Leg_data$BUN[missing_BUN & Available_cr] = predict(mod_impute4,newdata=Leg_data[missing_BUN & Available_cr,], re.form=NA)
```

Resulting data we can now use:
The contributions of the different studies:
```{r}
vars_interest = c('outcome','HCT','LPAR_pct','BD','BUN','poedema',
                  'convulsions','coma','AgeInYear','drug_class')
complete_cases = apply(Leg_data[,vars_interest], 1, function(x) sum(is.na(x))) == 0
Complete_Leg_data = Leg_data[complete_cases,] # for the model fitting
Complete_Leg_data$studyID = as.factor(as.character(Complete_Leg_data$studyID))
# Whole dataset
table(Leg_data$studyID)
# in the complete dataset (all variables recorded)
table(Complete_Leg_data$studyID)
Complete_Leg_data$drug_AS = 0
Complete_Leg_data$drug_AS[Complete_Leg_data$drug_class=='artemisinin']=1

# remove infinite log parasitaemias
ind_keep = !(is.infinite(Complete_Leg_data$LPAR_pct) | is.nan(Complete_Leg_data$LPAR_pct))
Complete_Leg_data = Complete_Leg_data[ind_keep,]

Complete_Leg_data$shock = as.numeric(Complete_Leg_data$shock)
Complete_Leg_data$poedema = as.numeric(Complete_Leg_data$poedema)
Complete_Leg_data$convulsions = as.numeric(Complete_Leg_data$convulsions)

Complete_Leg_data$country=as.factor(Complete_Leg_data$country)

```

Data summaries
```{r}
Africa = c('The Gambia','Mozambique','Ghana','Kenya','Nigeria','Tanzania','Uganda','Rwanda','Congo')
Asia = c('Thailand','Vietnam','Bangladesh','Myanmar','India','Indonesia')
writeLines(paste('Children in Africa:',
                 sum(Complete_Leg_data$AgeInYear < 15 & Complete_Leg_data$country %in% Africa)))
writeLines(paste('Adults in Africa:',
                 sum(Complete_Leg_data$AgeInYear >= 15 & Complete_Leg_data$country %in% Africa)))

writeLines(paste('Children in Asia:',
                 sum(Complete_Leg_data$AgeInYear < 15 & Complete_Leg_data$country %in% Asia)))
writeLines(paste('Adults in Asia:',
                 sum(Complete_Leg_data$AgeInYear >= 15 & Complete_Leg_data$country %in% Asia)))

```



# Unadjusted associations for death

```{r}
Factors = c('HCT','coma','BD','poedema','convulsions','BUN')
x_hcts = seq(4,45, by=1)
x_comas = 0:1
x_conv = 1:2
x_poedema = 1:2
x_bd = seq(-22,35, by=2)
x_BUN = seq(2,150, length.out = 2)
```

```{r UnAdjusted}
modHCT=gam(outcome ~ s(HCT) + s(studyID, bs='re') + s(country, bs='re'),
           data = Complete_Leg_data, family='binomial')

modcoma=gam(outcome ~ coma + s(studyID, bs='re') + s(country, bs='re'),
            data = Complete_Leg_data, family='binomial')

modBD=gam(outcome ~ s(BD) + s(studyID, bs='re') + s(country, bs='re'),
          data = Complete_Leg_data, family='binomial')

modpoedema=gam(outcome ~ poedema + s(studyID, bs='re') + s(country, bs='re'),
               data = Complete_Leg_data, family='binomial')

modconv=gam(outcome ~ convulsions + s(studyID, bs='re') + s(country, bs='re'),
            data = Complete_Leg_data, family='binomial')

modBUN=gam(outcome ~ s(BUN) + s(studyID, bs='re') + s(country, bs='re'),
           data = Complete_Leg_data, family='binomial')
```

```{r Unadjusted, echo=FALSE}
par(las=1, bty='n', mfrow=c(2,3))

#************** BD
predsBD = predict(modBD, newdata = data.frame(BD= x_bd, 
                                              studyID='AQ', 
                                              country='Thailand'), 
                  exclude = c("s(country)","s(studyID)"), 
                  type='response', se.fit=T)
plot(x_bd, 100*predsBD$fit, ylab='%', xlab='Base deficit (mEq/L)', 
     type='l', lwd=3,ylim = c(0,100))
polygon(c(x_bd, rev(x_bd)), c(100*predsBD$fit + 100*2*predsBD$se.fit,
                              rev(100*predsBD$fit - 100*2*predsBD$se.fit)),
        lty=2,lwd=2, border = NA, col = rgb(0, 0, 1,0.5))

#************** HCT
predsHCT = predict(modHCT, newdata = data.frame(HCT=x_hcts, 
                                                studyID='AQ', 
                                                country='Thailand'), 
                   exclude = c("s(country)","s(studyID)"), 
                   type='response', se.fit=T)
plot(x_hcts, 100*predsHCT$fit, ylab='%', xlab='Haematocrit (%)', 
     type='l', lwd=3,ylim = c(5,25))
polygon(c(x_hcts,rev(x_hcts)), c(100*predsHCT$fit + 100*2*predsHCT$se.fit, 
                                 rev(100*predsHCT$fit - 100*2*predsHCT$se.fit)),
        lty=2,lwd=2,border = NA, col = rgb(0, 0, 1,0.5))

#************** BUN
predsBUN = predict(modBUN, newdata = data.frame(BUN=x_BUN, 
                                                studyID='AQ', 
                                                country='Thailand'), 
                   exclude = c("s(country)","s(studyID)"), 
                   type='response', se.fit=T)
plot(log10(x_BUN), 100*predsBUN$fit, ylab='%', xlab='Blood urea nitrogen (mmol/L)', 
     type='l', lwd=3,ylim = c(0,60), xaxt='n')
axis(1, at = log10(c(2,10,100)), labels = c(2,10,100))
polygon(c(log10(x_BUN),rev(log10(x_BUN))), 
        c(100*predsBUN$fit + 100*2*predsBUN$se.fit,
          rev(100*predsBUN$fit - 100*2*predsBUN$se.fit)), 
        lty=2,lwd=2, border = NA, col = rgb(0, 0, 1,0.5))

#**************  Coma
predscoma = predict(modcoma, newdata = data.frame(coma=x_comas, 
                                                  studyID='AQ', 
                                                  country='Thailand'), 
                    exclude = c("s(country)","s(studyID)"), 
                    type='response', se.fit=T)
plot(x_comas, 100*predscoma$fit, ylab='%', xlab='', 
     type='l', lwd=3, ylim = c(0,26), xaxt='n')
axis(1, at=x_comas, labels = c('No Coma','Coma'))
polygon(c(x_comas,rev(x_comas)), 
        c(100*predscoma$fit + 100*2*predscoma$se.fit,
          rev(100*predscoma$fit -100*2*predscoma$se.fit)),
        lty=2,lwd=2, border = NA, col = rgb(0, 0, 1,0.5))

#************** Convulsions
predsconv = predict(modconv, newdata = data.frame(convulsions=x_conv, 
                                                  studyID='AQ', 
                                                  country='Thailand'), 
                    exclude = c("s(country)","s(studyID)"), 
                    type='response', se.fit=T)
plot(x_conv, 100*predsconv$fit, ylab='%', xlab='', 
     type='l', lwd=3, ylim = c(0,30), xaxt='n')
axis(1, at=x_conv, labels = c('No convulsions','Convulsions'))
polygon(c(x_conv,rev(x_conv)), 
        c(100*predsconv$fit + 100*2*predsconv$se.fit,
          rev(100*predsconv$fit -100*2*predsconv$se.fit)),
        lty=2,lwd=2, border = NA, col = rgb(0, 0, 1,0.5))

#************** Pulmonary Oedema
predspoedema = predict(modpoedema, newdata = data.frame(poedema=x_poedema, 
                                                        studyID='AQ', 
                                                        country='Thailand'), 
                       exclude = c("s(country)","s(studyID)"), 
                       type='response', se.fit=T)
plot(x_poedema, 100*predspoedema$fit, ylab='%', xlab='', 
     type='l', lwd=3, ylim = c(0,40), xaxt='n')
axis(1, at=x_poedema, labels = c('No PO','PO'))
polygon(c(x_poedema,rev(x_poedema)), 
        c(100*predspoedema$fit + 100*2*predspoedema$se.fit,
          rev(100*predspoedema$fit -100*2*predspoedema$se.fit)),
        lty=2,lwd=2, border = NA, col = rgb(0, 0, 1,0.5))
```





```{r deathmodel_glm}
mod_Adj = glmer(outcome ~ HCT + LPAR_pct + coma + convulsions +
                  poedema + log10(BUN) + BD + shock + drug_AS + 
                  AgeInYear + (1 | studyID) + (1 | country),
                data = Complete_Leg_data, family=binomial)
summary(mod_Adj)
```

Some summary functions we need
```{r}
fmed = function(x, ind){
  return(median(x[ind]))
}
f25 = function(x, ind){
  return(quantile(x[ind], probs = 0.25))
}
f75 = function(x, ind){
  return(quantile(x[ind], probs = 0.75))
}
```

Now let's make counterfactual retrodictions of anaemia on death for the patients in the database.

```{r counterfactualMortality}
myquantiles = c(0.025,0.5,0.975) # this is for a 95% CI
ys = 100*predict(mod_Adj, type='response')
BS = boot(data = ys, statistic = fmed, R = 300)
overall_median_mortality = quantile(BS$t, probs = myquantiles)
```



Compute the counterfactual outcomes:

```{r}
#*********HCT
HCT_CFs = array(dim = c(9, length(x_hcts)))
for(i in 1:length(x_hcts)){
  mydata = Complete_Leg_data
  mydata$HCT=x_hcts[i]
  ys = 100*predict(mod_Adj, newdata = mydata,  type='response')
  BSmed = boot(data = ys, statistic = fmed, R = 300)
  BS25 = boot(data = ys, statistic = f25, R = 300)
  BS75 = boot(data = ys, statistic = f75, R = 300)
  
  HCT_CFs[,i] = c(quantile(BS25$t, probs = myquantiles),
                  quantile(BSmed$t, probs = myquantiles),
                  quantile(BS75$t, probs = myquantiles))
}
#*********BD
BD_CFs = array(dim = c(9, length(x_bd)))
for(i in 1:length(x_bd)){
  mydata = Complete_Leg_data
  mydata$BD=x_bd[i]
  ys = 100*predict(mod_Adj, newdata = mydata, type='response')
  BSmed = boot(data = ys, statistic = fmed, R = 300)
  BS25 = boot(data = ys, statistic = f25, R = 300)
  BS75 = boot(data = ys, statistic = f75, R = 300)
  
  BD_CFs[,i] = c(quantile(BS25$t, probs = myquantiles),
                 quantile(BSmed$t, probs = myquantiles),
                 quantile(BS75$t, probs = myquantiles))
}
#*********BUN
BUN_CFs = array(dim = c(9, length(x_BUN)))
for(i in 1:length(x_BUN)){
  mydata = Complete_Leg_data
  mydata$BUN=x_BUN[i]
  ys = 100*predict(mod_Adj, newdata = mydata,  type='response')
  BSmed = boot(data = ys, statistic = fmed, R = 300)
  BS25 = boot(data = ys, statistic = f25, R = 300)
  BS75 = boot(data = ys, statistic = f75, R = 300)
  
  BUN_CFs[,i] = c(quantile(BS25$t, probs = myquantiles),
                  quantile(BSmed$t, probs = myquantiles),
                  quantile(BS75$t, probs = myquantiles))
}
#*********Coma
coma_CFs = array(dim = c(9, length(x_comas)))
for(i in 1:length(x_comas)){
  mydata = Complete_Leg_data
  mydata$coma=x_comas[i]
  ys = 100*predict(mod_Adj, newdata = mydata,  type='response')
  BSmed = boot(data = ys, statistic = fmed, R = 300)
  BS25 = boot(data = ys, statistic = f25, R = 300)
  BS75 = boot(data = ys, statistic = f75, R = 300)
  
  coma_CFs[,i] = c(quantile(BS25$t, probs = myquantiles),
                   quantile(BSmed$t, probs = myquantiles),
                   quantile(BS75$t, probs = myquantiles))
}
#*********poedema
PO_CFs = array(dim = c(9, length(x_poedema)))
for(i in 1:length(x_poedema)){
  mydata = Complete_Leg_data
  mydata$poedema=x_poedema[i]
  ys = 100*predict(mod_Adj, newdata = mydata, type='response')
  BSmed = boot(data = ys, statistic = fmed, R = 300)
  BS25 = boot(data = ys, statistic = f25, R = 300)
  BS75 = boot(data = ys, statistic = f75, R = 300)
  
  PO_CFs[,i] = c(quantile(BS25$t, probs = myquantiles),
                 quantile(BSmed$t, probs = myquantiles),
                 quantile(BS75$t, probs = myquantiles))
}
#*********Convulsions
Conv_CFs = array(dim = c(9, length(x_conv)))
for(i in 1:length(x_conv)){
  mydata = Complete_Leg_data
  mydata$convulsions=x_conv[i]
  ys = 100*predict(mod_Adj, newdata = mydata,  type='response')
  BSmed = boot(data = ys, statistic = fmed, R = 300)
  BS25 = boot(data = ys, statistic = f25, R = 300)
  BS75 = boot(data = ys, statistic = f75, R = 300)
  
  Conv_CFs[,i] = c(quantile(BS25$t, probs = myquantiles),
                   quantile(BSmed$t, probs = myquantiles),
                   quantile(BS75$t, probs = myquantiles))
}
```

The way to interpret this `counterfactual' plot is as follows: suppose that every individual in the dataset was assigned (as in a intervention) a specific haematocrit $X$, what would the resulting per patient probability of death be. Here we summarise these probabilities by the predicted mean probability of death and 80\% predictive intervals.

```{r CounterfactualPlots_GLM, echo=FALSE}
par(las=1, bty='n', mfrow=c(2,3))
ylabel = 'Probability death'
#************************** HCT
plot(x_hcts,HCT_CFs[5,], xlim=c(4,45), ylab=ylabel, 
     xlab='Haematocrit (%)', ylim=c(0,22), lty=1, lwd=2, type='l')
polygon(c(x_hcts, rev(x_hcts)), c(HCT_CFs[4,], rev(HCT_CFs[6,])),
        border = NA, col = rgb(1, 0, 0,0.5))
lines(x_hcts,HCT_CFs[2,], xlim=c(4,45))
polygon(c(x_hcts, rev(x_hcts)), c(HCT_CFs[1,], rev(HCT_CFs[3,])),
        border = NA, col = rgb(1, 0, 0,0.5))
lines(x_hcts,HCT_CFs[8,], xlim=c(4,45))
polygon(c(x_hcts, rev(x_hcts)), c(HCT_CFs[7,], rev(HCT_CFs[9,])),
        border = NA, col = rgb(1, 0, 0,0.5))
lines(x_hcts, rep(overall_median_mortality[2], length(x_hcts)), lwd=1, col='blue',lty=1)
polygon(c(x_hcts, rev(x_hcts)), 
        c(rep(overall_median_mortality[1],length(x_hcts)),
          rep(overall_median_mortality[3], length(x_hcts))),
        border = NA, col = rgb(0, 0, 1,0.5))

#************************** BD
plot(x_bd,BD_CFs[5,], ylab=ylabel, 
     xlab='Base deficit (mEq/L)', ylim=c(0,80), lty=1, lwd=1, type='l')
lines(x_bd, BD_CFs[2,], lty=1, lwd=1)
lines(x_bd, BD_CFs[8,], lty=1, lwd=1)
polygon(c(x_bd, rev(x_bd)), c(BD_CFs[4,], rev(BD_CFs[6,])),
        border = NA, col = rgb(1, 0, 0,0.5))
polygon(c(x_bd, rev(x_bd)), c(BD_CFs[1,], rev(BD_CFs[3,])),
        border = NA, col = rgb(1, 0, 0,0.5))
polygon(c(x_bd, rev(x_bd)), c(BD_CFs[7,], rev(BD_CFs[9,])),
        border = NA, col = rgb(1, 0, 0,0.5))
# Overall effect
lines(x_bd, rep(overall_median_mortality[2], length(x_bd)), lwd=1, col='blue',lty=1)
polygon(c(x_bd, rev(x_bd)), 
        c(rep(overall_median_mortality[1],length(x_bd)),
          rep(overall_median_mortality[3], length(x_bd))),
        border = NA, col = rgb(0, 0, 1,0.5))

#************************** BUN
plot(log10(x_BUN),BUN_CFs[5,], ylab=ylabel, xaxt='n',
     xlab='Blood urea nitrogen (mmol/L)', ylim=c(0,45), 
     lty=1, lwd=1, type='l')
axis(1, at = log10(c(2,10,100)), labels = c(2,10,100))
lines(log10(x_BUN), BUN_CFs[2,], lty=1, lwd=1)
lines(log10(x_BUN), BUN_CFs[8,], lty=1, lwd=1)
polygon(log10(c(x_BUN, rev(x_BUN))), c(BUN_CFs[4,], rev(BUN_CFs[6,])),
        border = NA, col = rgb(1, 0, 0,0.5))
polygon(log10(c(x_BUN, rev(x_BUN))), c(BUN_CFs[1,], rev(BUN_CFs[3,])),
        border = NA, col = rgb(1, 0, 0,0.5))
polygon(log10(c(x_BUN, rev(x_BUN))), c(BUN_CFs[7,], rev(BUN_CFs[9,])),
        border = NA, col = rgb(1, 0, 0,0.5))
# Overall effect
lines(log10(x_BUN), rep(overall_median_mortality[2], length(x_BUN)), lwd=1, col='blue',lty=1)
polygon(log10(c(x_BUN, rev(x_BUN))), 
        c(rep(overall_median_mortality[1],length(x_BUN)),
          rep(overall_median_mortality[3], length(x_BUN))),
        border = NA, col = rgb(0, 0, 1,0.5))

#************************** Coma
plot(x_comas,coma_CFs[5,], ylab=ylabel, xaxt='n',
     xlab='', ylim=c(0,30), lty=1, lwd=1, type='l')
axis(1, at = 0:1, labels = c('No coma','Coma'))
lines(x_comas, coma_CFs[2,], lty=1, lwd=1)
lines(x_comas, coma_CFs[8,], lty=1, lwd=1)
polygon(c(x_comas, rev(x_comas)), c(coma_CFs[4,], rev(coma_CFs[6,])),
        border = NA, col = rgb(1, 0, 0,0.5))
polygon(c(x_comas, rev(x_comas)), c(coma_CFs[1,], rev(coma_CFs[3,])),
        border = NA, col = rgb(1, 0, 0,0.5))
polygon(c(x_comas, rev(x_comas)), c(coma_CFs[7,], rev(coma_CFs[9,])),
        border = NA, col = rgb(1, 0, 0,0.5))
# Overall effect
lines(x_comas, rep(overall_median_mortality[2], length(x_comas)), lwd=1, col='blue',lty=1)
polygon(c(x_comas, rev(x_comas)), 
        c(rep(overall_median_mortality[1],length(x_comas)),
          rep(overall_median_mortality[3], length(x_comas))),
        border = NA, col = rgb(0, 0, 1,0.5))

#************************** Convulsions
plot(x_conv,Conv_CFs[5,], ylab=ylabel, xaxt='n',
     xlab='', ylim=c(0,40), lty=1, lwd=1, type='l')
axis(1, at = x_conv, labels = c('No convulsions','Convulsions'))
lines(x_conv, Conv_CFs[2,], lty=1, lwd=1)
lines(x_conv, Conv_CFs[8,], lty=1, lwd=1)
polygon(c(x_conv, rev(x_conv)), c(Conv_CFs[4,], rev(Conv_CFs[6,])),
        border = NA, col = rgb(1, 0, 0,0.5))
polygon(c(x_conv, rev(x_conv)), c(Conv_CFs[1,], rev(Conv_CFs[3,])),
        border = NA, col = rgb(1, 0, 0,0.5))
polygon(c(x_conv, rev(x_conv)), c(Conv_CFs[7,], rev(Conv_CFs[9,])),
        border = NA, col = rgb(1, 0, 0,0.5))
# Overall effect
lines(x_conv, rep(overall_median_mortality[2], length(x_conv)), lwd=1, col='blue',lty=1)
polygon(c(x_conv, rev(x_conv)), 
        c(rep(overall_median_mortality[1],length(x_conv)),
          rep(overall_median_mortality[3], length(x_conv))),
        border = NA, col = rgb(0, 0, 1,0.5))

#************************** Pulmonary Oedema
plot(x_poedema,PO_CFs[5,], ylab=ylabel, xaxt='n',
     xlab='', ylim=c(0,40), lty=1, lwd=1, type='l')
axis(1, at = x_poedema, labels = c('No PO','PO'))
lines(x_poedema, PO_CFs[2,], lty=1, lwd=1)
lines(x_poedema, PO_CFs[8,], lty=1, lwd=1)
polygon(c(x_poedema, rev(x_poedema)), c(PO_CFs[4,], rev(PO_CFs[6,])),
        border = NA, col = rgb(1, 0, 0,0.5))
polygon(c(x_poedema, rev(x_poedema)), c(PO_CFs[1,], rev(PO_CFs[3,])),
        border = NA, col = rgb(1, 0, 0,0.5))
polygon(c(x_poedema, rev(x_poedema)), c(PO_CFs[7,], rev(PO_CFs[9,])),
        border = NA, col = rgb(1, 0, 0,0.5))
# Overall effect
lines(x_poedema, rep(overall_median_mortality[2], length(x_poedema)), lwd=1, col='blue',lty=1)
polygon(c(x_poedema, rev(x_poedema)), 
        c(rep(overall_median_mortality[1],length(x_poedema)),
          rep(overall_median_mortality[3], length(x_poedema))),
        border = NA, col = rgb(0, 0, 1,0.5))
```


## More complex GAM model

The GAM model allows for non-linear relationships between certain variables and the outcome.

Here we fit as non-linear the effect of age and haematocrit on mortality.
We add a random effect term for the studyID and a random effect term for the country.
This should be adjusting for a confounder of quality of care (which potentially impacts both general anaemia and outcome in study).

```{r deathmodel_GAM}
mod_Adj_GAM = gam(outcome ~ s(HCT) + LPAR_pct + coma + convulsions +
                    poedema + s(log10(BUN)) + s(BD) + shock + 
                    drug_AS + AgeInYear + 
                    s(studyID, bs='re') + s(country, bs='re'),
                  data=Complete_Leg_data, family=binomial)
summary(mod_Adj_GAM)
```


Now we compute the corresponding counterfactual probabilities of death for the dataset for all values of the haematocrit:

```{r }
#*********HCT
HCT_CFs = array(dim = c(9, length(x_hcts)))
for(i in 1:length(x_hcts)){
  mydata = Complete_Leg_data
  mydata$HCT=x_hcts[i]
  preds = predict(mod_Adj_GAM, newdata = mydata,  type='response', se.fit = T)
  ys = preds$fit
  BSmed = boot(data = ys, statistic = fmed, R = 300)
  BS25 = boot(data = ys, statistic = f25, R = 300)
  BS75 = boot(data = ys, statistic = f75, R = 300)
  
  HCT_CFs[,i] = c(quantile(BS25$t, probs = myquantiles),
                  quantile(BSmed$t, probs = myquantiles),
                  quantile(BS75$t, probs = myquantiles))
}
#*********BD
BD_CFs = array(dim = c(9, length(x_bd)))
for(i in 1:length(x_bd)){
  mydata = Complete_Leg_data
  mydata$BD=x_bd[i]
  ys = 100*predict(mod_Adj_GAM, newdata = mydata, type='response')
  BSmed = boot(data = ys, statistic = fmed, R = 300)
  BS25 = boot(data = ys, statistic = f25, R = 300)
  BS75 = boot(data = ys, statistic = f75, R = 300)
  
  BD_CFs[,i] = c(quantile(BS25$t, probs = myquantiles),
                 quantile(BSmed$t, probs = myquantiles),
                 quantile(BS75$t, probs = myquantiles))
}
#*********BUN
BUN_CFs = array(dim = c(9, length(x_BUN)))
for(i in 1:length(x_BUN)){
  mydata = Complete_Leg_data
  mydata$BUN=x_BUN[i]
  ys = 100*predict(mod_Adj_GAM, newdata = mydata,  type='response')
  BSmed = boot(data = ys, statistic = fmed, R = 300)
  BS25 = boot(data = ys, statistic = f25, R = 300)
  BS75 = boot(data = ys, statistic = f75, R = 300)
  
  BUN_CFs[,i] = c(quantile(BS25$t, probs = myquantiles),
                  quantile(BSmed$t, probs = myquantiles),
                  quantile(BS75$t, probs = myquantiles))
}
#*********Coma
coma_CFs = array(dim = c(9, length(x_comas)))
for(i in 1:length(x_comas)){
  mydata = Complete_Leg_data
  mydata$coma=x_comas[i]
  ys = 100*predict(mod_Adj_GAM, newdata = mydata,  type='response')
  BSmed = boot(data = ys, statistic = fmed, R = 300)
  BS25 = boot(data = ys, statistic = f25, R = 300)
  BS75 = boot(data = ys, statistic = f75, R = 300)
  
  coma_CFs[,i] = c(quantile(BS25$t, probs = myquantiles),
                   quantile(BSmed$t, probs = myquantiles),
                   quantile(BS75$t, probs = myquantiles))
}
#*********poedema
PO_CFs = array(dim = c(9, length(x_poedema)))
for(i in 1:length(x_poedema)){
  mydata = Complete_Leg_data
  mydata$poedema=x_poedema[i]
  ys = 100*predict(mod_Adj_GAM, newdata = mydata, type='response')
  BSmed = boot(data = ys, statistic = fmed, R = 300)
  BS25 = boot(data = ys, statistic = f25, R = 300)
  BS75 = boot(data = ys, statistic = f75, R = 300)
  
  PO_CFs[,i] = c(quantile(BS25$t, probs = myquantiles),
                 quantile(BSmed$t, probs = myquantiles),
                 quantile(BS75$t, probs = myquantiles))
}
#*********Convulsions
Conv_CFs = array(dim = c(9, length(x_conv)))
for(i in 1:length(x_conv)){
  mydata = Complete_Leg_data
  mydata$convulsions=x_conv[i]
  ys = 100*predict(mod_Adj_GAM, newdata = mydata,  type='response')
  BSmed = boot(data = ys, statistic = fmed, R = 300)
  BS25 = boot(data = ys, statistic = f25, R = 300)
  BS75 = boot(data = ys, statistic = f75, R = 300)
  
  Conv_CFs[,i] = c(quantile(BS25$t, probs = myquantiles),
                   quantile(BSmed$t, probs = myquantiles),
                   quantile(BS75$t, probs = myquantiles))
}
```

We see that the effect of haematocrit on mortality is non-linear under this model: below 20 is protective, above 20 plateaus out:

```{r counterfactualPlots_GAM, echo=FALSE}
par(las=1, bty='n', mfrow=c(2,3))
ylabel = 'Probability death'
#************************** HCT
plot(x_hcts,HCT_CFs[5,], xlim=c(4,45), ylab=ylabel, 
     xlab='Haematocrit (%)', ylim=c(0,22), lty=1, lwd=2, type='l')
polygon(c(x_hcts, rev(x_hcts)), c(HCT_CFs[4,], rev(HCT_CFs[6,])),
        border = NA, col = rgb(1, 0, 0,0.5))
lines(x_hcts,HCT_CFs[2,], xlim=c(4,45))
polygon(c(x_hcts, rev(x_hcts)), c(HCT_CFs[1,], rev(HCT_CFs[3,])),
        border = NA, col = rgb(1, 0, 0,0.5))
lines(x_hcts,HCT_CFs[8,], xlim=c(4,45))
polygon(c(x_hcts, rev(x_hcts)), c(HCT_CFs[7,], rev(HCT_CFs[9,])),
        border = NA, col = rgb(1, 0, 0,0.5))
lines(x_hcts, rep(overall_median_mortality[2], length(x_hcts)), lwd=1, col='blue',lty=1)
polygon(c(x_hcts, rev(x_hcts)), 
        c(rep(overall_median_mortality[1],length(x_hcts)),
          rep(overall_median_mortality[3], length(x_hcts))),
        border = NA, col = rgb(0, 0, 1,0.5))

#************************** BD
plot(x_bd,BD_CFs[5,], ylab=ylabel, 
     xlab='Base deficit (mEq/L)', ylim=c(0,80), lty=1, lwd=1, type='l')
lines(x_bd, BD_CFs[2,], lty=1, lwd=1)
lines(x_bd, BD_CFs[8,], lty=1, lwd=1)
polygon(c(x_bd, rev(x_bd)), c(BD_CFs[4,], rev(BD_CFs[6,])),
        border = NA, col = rgb(1, 0, 0,0.5))
polygon(c(x_bd, rev(x_bd)), c(BD_CFs[1,], rev(BD_CFs[3,])),
        border = NA, col = rgb(1, 0, 0,0.5))
polygon(c(x_bd, rev(x_bd)), c(BD_CFs[7,], rev(BD_CFs[9,])),
        border = NA, col = rgb(1, 0, 0,0.5))
# Overall effect
lines(x_bd, rep(overall_median_mortality[2], length(x_bd)), lwd=1, col='blue',lty=1)
polygon(c(x_bd, rev(x_bd)), 
        c(rep(overall_median_mortality[1],length(x_bd)),
          rep(overall_median_mortality[3], length(x_bd))),
        border = NA, col = rgb(0, 0, 1,0.5))

#************************** BUN
plot(log10(x_BUN),BUN_CFs[5,], ylab=ylabel, xaxt='n',
     xlab='Blood urea nitrogen (mmol/L)', ylim=c(0,45), 
     lty=1, lwd=1, type='l')
axis(1, at = log10(c(2,10,100)), labels = c(2,10,100))
lines(log10(x_BUN), BUN_CFs[2,], lty=1, lwd=1)
lines(log10(x_BUN), BUN_CFs[8,], lty=1, lwd=1)
polygon(log10(c(x_BUN, rev(x_BUN))), c(BUN_CFs[4,], rev(BUN_CFs[6,])),
        border = NA, col = rgb(1, 0, 0,0.5))
polygon(log10(c(x_BUN, rev(x_BUN))), c(BUN_CFs[1,], rev(BUN_CFs[3,])),
        border = NA, col = rgb(1, 0, 0,0.5))
polygon(log10(c(x_BUN, rev(x_BUN))), c(BUN_CFs[7,], rev(BUN_CFs[9,])),
        border = NA, col = rgb(1, 0, 0,0.5))
# Overall effect
lines(log10(x_BUN), 
      rep(overall_median_mortality[2], length(x_BUN)), 
      lwd=1, col='blue',lty=1)
polygon(log10(c(x_BUN, rev(x_BUN))), 
        c(rep(overall_median_mortality[1],length(x_BUN)),
          rep(overall_median_mortality[3], length(x_BUN))),
        border = NA, col = rgb(0, 0, 1,0.5))

#************************** Coma
plot(x_comas,coma_CFs[5,], ylab=ylabel, xaxt='n',
     xlab='', ylim=c(0,30), lty=1, lwd=1, type='l')
axis(1, at = 0:1, labels = c('No coma','Coma'))
lines(x_comas, coma_CFs[2,], lty=1, lwd=1)
lines(x_comas, coma_CFs[8,], lty=1, lwd=1)
polygon(c(x_comas, rev(x_comas)), c(coma_CFs[4,], rev(coma_CFs[6,])),
        border = NA, col = rgb(1, 0, 0,0.5))
polygon(c(x_comas, rev(x_comas)), c(coma_CFs[1,], rev(coma_CFs[3,])),
        border = NA, col = rgb(1, 0, 0,0.5))
polygon(c(x_comas, rev(x_comas)), c(coma_CFs[7,], rev(coma_CFs[9,])),
        border = NA, col = rgb(1, 0, 0,0.5))
# Overall effect
lines(x_comas, rep(overall_median_mortality[2], length(x_comas)), lwd=1, col='blue',lty=1)
polygon(c(x_comas, rev(x_comas)), 
        c(rep(overall_median_mortality[1],length(x_comas)),
          rep(overall_median_mortality[3], length(x_comas))),
        border = NA, col = rgb(0, 0, 1,0.5))

#************************** Convulsions
plot(x_conv,Conv_CFs[5,], ylab=ylabel, xaxt='n',
     xlab='', ylim=c(0,30), lty=1, lwd=1, type='l')
axis(1, at = x_conv, labels = c('No convulsions','Convulsions'))
lines(x_conv, Conv_CFs[2,], lty=1, lwd=1)
lines(x_conv, Conv_CFs[8,], lty=1, lwd=1)
polygon(c(x_conv, rev(x_conv)), c(Conv_CFs[4,], rev(Conv_CFs[6,])),
        border = NA, col = rgb(1, 0, 0,0.5))
polygon(c(x_conv, rev(x_conv)), c(Conv_CFs[1,], rev(Conv_CFs[3,])),
        border = NA, col = rgb(1, 0, 0,0.5))
polygon(c(x_conv, rev(x_conv)), c(Conv_CFs[7,], rev(Conv_CFs[9,])),
        border = NA, col = rgb(1, 0, 0,0.5))
# Overall effect
lines(x_conv, rep(overall_median_mortality[2], length(x_conv)), lwd=1, col='blue',lty=1)
polygon(c(x_conv, rev(x_conv)), 
        c(rep(overall_median_mortality[1],length(x_conv)),
          rep(overall_median_mortality[3], length(x_conv))),
        border = NA, col = rgb(0, 0, 1,0.5))

#************************** Pulmonary Oedema
plot(x_poedema,PO_CFs[5,], ylab=ylabel, xaxt='n',
     xlab='', ylim=c(0,30), lty=1, lwd=1, type='l')
axis(1, at = x_poedema, labels = c('No PO','PO'))
lines(x_poedema, PO_CFs[2,], lty=1, lwd=1)
lines(x_poedema, PO_CFs[8,], lty=1, lwd=1)
polygon(c(x_poedema, rev(x_poedema)), c(PO_CFs[4,], rev(PO_CFs[6,])),
        border = NA, col = rgb(1, 0, 0,0.5))
polygon(c(x_poedema, rev(x_poedema)), c(PO_CFs[1,], rev(PO_CFs[3,])),
        border = NA, col = rgb(1, 0, 0,0.5))
polygon(c(x_poedema, rev(x_poedema)), c(PO_CFs[7,], rev(PO_CFs[9,])),
        border = NA, col = rgb(1, 0, 0,0.5))
# Overall effect
lines(x_poedema, rep(overall_median_mortality[2], length(x_poedema)), lwd=1, col='blue',lty=1)
polygon(c(x_poedema, rev(x_poedema)), 
        c(rep(overall_median_mortality[1],length(x_poedema)),
          rep(overall_median_mortality[3], length(x_poedema))),
        border = NA, col = rgb(0, 0, 1,0.5))
```


## Model comparison

Which model is better fit in terms of AIC

```{r}
print(AIC(mod_Adj_GAM, mod_Adj))
```

And in terms of deviance

```{r}
print(list(mod_Adj_GAM=deviance(mod_Adj_GAM),
           mod_Adj = deviance(mod_Adj)))
```

