---
title: "Charactersing effect of anaemia on mortality in severe malaria"
output:
  html_document:
    keep_md: yes
    fig_caption: yes
---

```{r, echo=F}
knitr::opts_chunk$set(cache = TRUE, cache.comments = FALSE, 
                      echo = TRUE, include = TRUE, 
                      fig.width = 7, fig.height = 7,
                      fig.pos = 'H', 
                      dev = 'png', dpi = 300)

RUN_M_IMPUTATION = F
RUN_MODELS = F
```

# Background

This looks at the severe malaria legacy dataset from MORU

```{r, echo=FALSE}
load('RData/Data.RData')
m$drug_AS = 0
m$drug_AS[m$drug_class=='artemisinin']=1
```




```{r, echo=FALSE, include=FALSE}
library(lme4)
require(missForest)
library(merTools)
```



Data summaries
```{r}
Africa = c('The Gambia','Mozambique','Ghana','Kenya','Nigeria','Tanzania','Uganda','Rwanda','Congo')
Asia = c('Thailand','Vietnam','Bangladesh','Myanmar','India','Indonesia')
writeLines(paste('Children in Africa:',
                 sum(m$AgeInYear < 15 & m$country %in% Africa)))
writeLines(paste('Adults in Africa:',
                 sum(m$AgeInYear >= 15 & m$country %in% Africa)))

writeLines(paste('Children in Asia:',
                 sum(m$AgeInYear < 15 & m$country %in% Asia)))
writeLines(paste('Adults in Asia:',
                 sum(m$AgeInYear >= 15 & m$country %in% Asia)))

```

### Multiple imputation using missForest

The number of missing variables in the pooled data:
```{r}
apply(m,2, function(x) sum(is.na(x)))
```

We make a few data adjustments for the model imputation and fitting:
```{r}
m$LPAR_pct[is.infinite(m$LPAR_pct)] = 0
m$drug_class = as.factor(m$drug_class)
m$poedema = as.factor(m$poedema)
m$coma = as.factor(m$coma)
m$convulsions = as.factor(m$convulsions)
m$transfusion = as.factor(m$transfusion)
```

We run the multiple imputation using missForest
```{r, include=FALSE}
# This takes a long time to run....
if(RUN_M_IMPUTATION){
  registerDoParallel(cores = 6)
  impute_vars = c('shock','coma','LPAR_pct','BD','BUN','poedema','HCT',
                  'convulsions',"AgeInYear","paraul","parc","LPAR","transfusion",
                  'rr', 'lactate', 'bicarbonate', 'creatinine',"hypoglycaemia")
  SM_Impute_List = list()
  K = 150
  for(i in 1:K){
    Imputed_SM_vars = missForest(xmis = m[,impute_vars], decreasing = T,
                                 maxiter = 10, 
                                 variablewise = T,parallelize = 'forests')
    SM_data = Imputed_SM_vars$ximp
    SM_data = cbind(SM_data, m[,c('outcome','studyID','country','drug_AS')])
    SM_Impute_List[[i]] = SM_data
  }
  
  save(SM_Impute_List, file = 'RData/Multiple_Imputed_Datasets.RData')
} else {
  load(file = 'RData/Multiple_Imputed_Datasets.RData')
}
```


# Logistic regression model

We fit the full model with adjustments as specified in the Methods section:
```{r deathmodel_glm}
if(RUN_MODELS){
  # the model formula
  DAG_fmla = "outcome ~ HCT + LPAR_pct + coma + convulsions + poedema + 
              log2(BUN) + BD + shock + hypoglycaemia + 
              drug_AS + (1 | studyID) + (1 | country)"
  # fit the model to each dataset
  modList= glmerModList(DAG_fmla, data = SM_Impute_List, family=binomial,parallel = T) 
  # save the output
  save(modList, file = 'RData/Models_List.RData')
} else {
  load('RData/Models_List.RData')
}
```

Compute the overall parameter estimates:
```{r}
# extract the fixed and random effects from all the model fits
# These functions then compute the overall estimates
FixedEffs = modelFixedEff(modList)
RandEffs = modelRandEffStats(modList)
print(FixedEffs)
print(RandEffs)
```

Aggregate results for plotting:
```{r}
# The scalar multiples to put the AORs on the correct scales
Scalar_f = c(1, 10, 1, 1, 1, 10, 1, log2(3), 1, 1, 1)
# Compute 95% CIs
Results = data.frame(lowerCI = exp(Scalar_f*(FixedEffs$estimate -
                                               1.96*FixedEffs$std.error)),
                     mean = exp(Scalar_f*(FixedEffs$estimate)),
                     upperCI = exp(Scalar_f*(FixedEffs$estimate +
                                               1.96*FixedEffs$std.error)))
rownames(Results) = FixedEffs$term
```

Make the 'forest' plot:
```{r ForestPlot_SM}
plotting_ind = rownames(Results) %in% c('BD','coma1','convulsions1','drug_AS','HCT','log2(BUN)','poedema1')
Results = Results[plotting_ind,]
x_ind = sort.int(Results$mean, index.return = T)$ix
Results = Results[x_ind,]
par(bty='n', las=1, mar = c(3,9,2,2))

Y_Labels = c('+10 mEq/L\nbase deficit',
             'Coma\non admission',
             'Seizures\non admission',
             'Artemisinin drug\nversus\nnon Artemisinin drug',
             '-10 % points\nabsolute haematocrit\non admission',
             '3 fold increase\nin blood urea\nnitrogen (mmol/L)',
             'Pulmonary\nOedema\non admission')
Y_Labels = Y_Labels[x_ind]

xlims = c(0.5, 4.5)
plot(NA,NA, xlim= log2(xlims), ylim = c(0,1),xaxt='n',
     xlab='', ylab='', yaxt='n')
axis(1, at = log2(c(0.5,1, 2,4)), labels = c(0.5,1, 2,4))
abline(v=0, lty=2, lwd=3, col='red')
yindex =1
ypos = seq(0,1,length.out = sum(plotting_ind))

Results['HCT',] = 1/Results['HCT',]
for(i in 1:nrow(Results)){
  arrows(log2(Results[i,'lowerCI']),ypos[yindex],
         log2(Results[i,'upperCI']),ypos[yindex],
         length=0.05, angle=90, code=3, 
         col = 'black',lwd=3)
  points(log2(Results[i,'mean']),ypos[yindex],pch=18,cex=2)
  yindex=yindex+1
  
}
abline(h=ypos, lty=3)
axis(side = 2, at = ypos, labels = Y_Labels,tick=FALSE)
mtext(side=1, line = 2, text = 'Adjusted odds ratio')
mtext(side = 3, line = 1, text = 'Increased survival',adj = 0)
mtext(side = 3, line = 1, text = 'Decreased survival',adj = 1)
```



